# Code generated by genconfig. DO NOT EDIT.
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - '**'
  schedule:
    - cron: '0 9 * * *'

# actions/upload-artifact does not os.ExpandEnv the value passed
# to it as a path. Hence we have to hard code a directory that
# exists outside of the code checkout directory, and set ARTEFACTS
# accordingly below.
#
# Tracking https://github.com/actions/upload-artifact/issues/8

env:
  GO111MODULE: "on"
  GOPROXY: "https://proxy.golang.org"
  ARTEFACTS: "/home/runner/.artefacts"
  CI: "true"
  DOCKER_HUB_USER: "govimci"
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  GH_USER: "x-access-token"
  GH_TOKEN: ${{ github.token }}
  GOVIM_TEST_RACE_SLOWDOWN: "1.5"
  RACE_BUILD: 784

name: Go
jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        go_version: ["go1.12.16", "go1.13.7", "go1.14rc1"]
        vim_flavor: ["vim", "gvim"]
        vim_version: ["v8.1.1711", "v8.1.2056", "v8.2.0213"]
    runs-on: ${{ matrix.os }}
    env:
      GO_VERSION: ${{ matrix.go_version }}
      VIM_FLAVOR: ${{ matrix.vim_flavor }}
      VIM_VERSION: ${{ matrix.vim_version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@722adc63f1aa60a57ec37892e133b1d319cae598
    - name: Build docker image
      run: ./_scripts/buildGovimImage.sh
    - name: Run Docker, run!
      if: success()
      run: ./_scripts/runDockerRun.sh
    - name: Tidy up
      if: success() || failure()
      run: ./_scripts/postRun.sh
    - name: Upload artefacts
      if: (success() || failure()) && env.CI_UPLOAD_ARTIFACTS == 'true'
      uses: actions/upload-artifact@3446296876d12d4e3a0f3145a3c87e67bf0a16b5
      with:
        path: /home/runner/.artefacts
        name: ${{ matrix.os }}_${{ matrix.go_version }}_${{ matrix.vim_flavor }}_${{ matrix.vim_version }}

  test-macos:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
        go_version: ['1.14.x']
        vim_version: ["master"]
    runs-on: ${{ matrix.os }}
    env:
      VIM_FLAVOR: vim
    steps:
    - name: Checkout code
      uses: actions/checkout@722adc63f1aa60a57ec37892e133b1d319cae598
    - name: Install Vim
      uses: ./github/actions/setupvim
      with:
        version: ${{ matrix.vim_version }}
    - name: Install Go
      uses: actions/setup-go@9fbc767707c286e568c92927bbf57d76b73e0892
      with:
        go-version: ${{ matrix.go_version }}
    - name: Vim version
      run: vim --version
    - name: Go version
      run: go version
    - name: Run tests
      run: go run ./internal/cmd/dots go test -timeout 30m ./...
